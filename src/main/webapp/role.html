<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" type="text/css" href="easyui/themes/default/easyui.css">
    <link rel="stylesheet" type="text/css" href="easyui/themes/icon.css">
    <script type="text/javascript" src="easyui/jquery.min.js"></script>
    <script type="text/javascript" src="easyui/jquery.easyui.min.js"></script>
    <script type="text/javascript" src="easyui/locale/easyui-lang-zh_CN.js"></script>
</head>
<script type="text/javascript">

    $(function(){

        $('#rolelist').datagrid({

            url:'/role/getPage.action',
            fit:true,
            fitColumns:true,
            //singleSelect:true,
            columns:[[
                {field:'',title:'',width:50,align:'center',checkbox:true},
                {field:'id',title:'ID',width:100,align:'center'},
                {field:'roleName',title:'角色名称',width:100,align:'center'}
            ]],
            toolbar: [{
                iconCls: 'icon-edit',
                text:'修改',
                handler: function(){
                    var sel = $('#userlist').datagrid('getSelections');
                }
            },'-',{
                iconCls: 'icon-help',
                text:'删除',
                handler: function(){

                    var sel = $('#userlist').datagrid('getSelections');

                }
            },'-',{
                iconCls: 'icon-help',
                text:'添加',
                handler: function(){
                    //显示表单之前，先清空数据
                    $('#userForm').form('clear');
                    //显示添加用户表单
                    $('#userAdd').dialog('open');  // open a window

                }
            },'-',{
                iconCls: 'icon-man',
                text:'分配权限',
                handler: function(){
                    var sel = $('#rolelist').datagrid('getSelections');
                    if(sel.length != 1){
                        $.messager.alert('信息','请选择一个角色进行分配');
                    }else{
                        var roleid = sel[0].id ;
                        $('#menuTree').tree({
                            url:'/menu/getAllMenuByRole.action',
                            queryParams:{roleid:roleid},
                            checkbox:true,
                            animate:true
                        });

                        $('#perm').dialog('open');  // open a window
                    }

                }
            }],
            pagination:true,
            pagePosition:'bottom',
            pageNumber:1,   //page
            pageSize:5,     //rows
            pageList:[5,10,15,20]




        });


        $('#saveBtn').click(function(){


            //form表单异步提交
            $('#userForm').form('submit', {
                url:'/user/save.action',
                onSubmit: function(){
                    // do some check
                    // return false to prevent submit;
                },
                success:function(data){
                    $('#userAdd').dialog('close');
                    $.messager.alert('信息',data);
                    $('#userlist').datagrid('reload');
                }
            });

        })
    })

    function save(){
        var roleid = $('#rolelist').datagrid('getSelections')[0].id;
        var str = $('#menuTree').tree('getChecked', ['checked','indeterminate']);
        var ids = '' ;
        for(var i = 0 ;i<str.length;i++){
            ids += str[i].id + ',' ;
        }
        $.ajax({
            url:'/role/savePerm.action',
            data:{
                roleid:roleid,
                ids:ids
            },
            success:function(msg){
                debugger;
                if(msg == 'yes'){
                    $.messager.alert('信息','权限分配成功');
                    $('#perm').dialog('close');
                }else{
                    $.messager.alert('信息','权限分配失败');
                }
            }
        })

    }

</script>
<body>
<table id="rolelist"></table>

<div id="perm" class="easyui-dialog" title="分配权限" style="width:300px;height:300px;"
     data-options="iconCls:'icon-save',resizable:false,modal:true,closed:true,
        	buttons:[{
				text:'保存',
				iconCls:'icon-save',
				handler:save
			},{
				text:'关闭',
				iconCls:'icon-cancel',
				handler:function(){}
			}]">

    <ul id="menuTree" class="easyui-tree" data-options="url:'/menu/getAllMenuByRole.action?roleid=2',checkbox:true"></ul>

</div>



</body>
</html>